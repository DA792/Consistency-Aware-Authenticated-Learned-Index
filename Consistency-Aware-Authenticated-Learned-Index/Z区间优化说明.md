# Z 区间数量优化

## ✅ 已完成的修改

### 修改文件
`src/utils/ZOrderDecomposition.java` 第 57-58 行

### 修改内容

```java
// 优化前
if (level >= 15 || (zEnd - zStart) <= 1) {
    intervals.add(new ZInterval(zStart, zEnd, zRegion));
    return;
}

// 优化后
if (level >= 10 || (zEnd - zStart) <= 1) {
    intervals.add(new ZInterval(zStart, zEnd, zRegion));
    return;
}
```

## 🎯 优化原理

### Z-order 分解递归深度

```
递归深度越大 → 区间分解越细 → Z区间数越多 → 查询次数越多

level >= 15 (优化前):
  - 最多递归 15 层
  - 产生大量小区间
  - 选择性 0.02 时: 2811 个区间

level >= 10 (优化后):
  - 最多递归 10 层
  - 产生较少的较大区间
  - 预期: 500-1000 个区间
```

## 📊 预期效果

### Z 区间数量变化

| 选择性 | 优化前 (level≥15) | 优化后 (level≥10) | 减少 |
|--------|------------------|------------------|------|
| 0.0001 | 195 | ~50-80 | 60-70% |
| 0.001 | 625 | ~150-250 | 60-75% |
| 0.005 | 1403 | ~350-500 | 65-75% |
| 0.01 | 2012 | ~500-700 | 65-75% |
| 0.015 | 2434 | ~600-850 | 65-75% |
| 0.02 | 2811 | ~700-1000 | 65-75% |

### 性能提升预期

| 选择性 | 优化前总时间 | 优化后预期 | 提升 |
|--------|------------|-----------|------|
| 0.001 | 2.73 ms | ~1.0 ms | 2.7倍 |
| 0.01 | 11.18 ms | ~4.0 ms | 2.8倍 |
| 0.02 | 11.66 ms | ~4.2 ms | 2.8倍 |

## ⚠️ 可能的副作用

### 1. 假阳性率可能增加

```
区间变大 → 包含更多不相关的点 → 需要过滤更多候选点
```

**影响**: 
- 假阳性率可能从 0% 增加到 5-10%
- 但由于查询次数大幅减少,总体仍然更快

### 2. VO 大小可能略微增加

```
每个区间更大 → 单个区间的 VO 可能更大
但区间总数减少 → 总 VO 大小可能减少
```

**影响**:
- 单个查询的 VO: 可能增加 10-20%
- 总 VO 大小: 可能减少 30-50%

### 3. 查询精度略微下降

```
区间粒度变粗 → 边界处理不够精细
```

**影响**:
- 对大多数查询影响很小
- 边界情况可能需要检查更多点

## 🔧 如何测试

### 运行测试脚本

```batch
test_z_optimization.bat
```

### 观察关键指标

1. **Z 区间数**: 应该从 2811 降到 700-1000
2. **总时间**: 应该从 11.66 ms 降到 4-5 ms
3. **假阳性率**: 观察是否在可接受范围
4. **VO 大小**: 观察总 VO 大小变化

## 📈 与其他优化组合

### 组合优化 1: Z区间优化 + 增大误差界限

```java
// ZOrderDecomposition.java
if (level >= 10 || (zEnd - zStart) <= 1) {  // ✅ 已修改

// Spatial2DPVLTree.java
int err = 64;  // 从 32 改为 64
```

**预期效果**:
- Z 区间数: 2811 → 700-1000 (减少 65%)
- 单次查询: 更快 (树更小)
- **总提升: 4-6 倍**

### 组合优化 2: 激进优化

```java
// ZOrderDecomposition.java
if (level >= 8 || (zEnd - zStart) <= 1) {  // 更激进: 降到 8

// Spatial2DPVLTree.java
int err = 128;  // 更大的误差界限
```

**预期效果**:
- Z 区间数: 2811 → 300-500 (减少 80%)
- 单次查询: 非常快
- **总提升: 8-12 倍**

**注意**: 假阳性率可能增加到 10-20%

## 🎯 推荐配置

### 配置 1: 保守优化 (推荐)

```java
// ZOrderDecomposition.java
if (level >= 10 || (zEnd - zStart) <= 1) {  // ✅ 当前配置

// Spatial2DPVLTree.java
int err = 32;  // 保持不变
```

- 性能提升: 2-3 倍
- 副作用: 很小
- **适合大多数场景**

### 配置 2: 平衡优化

```java
// ZOrderDecomposition.java
if (level >= 10 || (zEnd - zStart) <= 1) {  // ✅ 当前配置

// Spatial2DPVLTree.java
int err = 64;  // 增大误差界限
```

- 性能提升: 4-6 倍
- 副作用: 中等
- **推荐用于性能要求高的场景**

### 配置 3: 激进优化

```java
// ZOrderDecomposition.java
if (level >= 8 || (zEnd - zStart) <= 1) {  // 改为 8

// Spatial2DPVLTree.java
int err = 128;  // 大幅增大误差界限
```

- 性能提升: 8-12 倍
- 副作用: 较大
- **仅用于对性能要求极高的场景**

## 📝 测试结果记录

### 优化前 (level >= 15, err = 32)

```
选择性 0.02:
- 查询时间: 1.13 ms
- 验证时间: 10.53 ms
- 总时间: 11.66 ms
- Z区间数: 2811
- VO大小: 1798.85 KB
```

### 优化后 (level >= 10, err = 32)

运行 `test_z_optimization.bat` 查看实际结果:

```
选择性 0.02:
- 查询时间: ___ ms
- 验证时间: ___ ms
- 总时间: ___ ms
- Z区间数: ___
- VO大小: ___ KB
```

## 🚀 下一步

1. **运行测试**: `test_z_optimization.bat`
2. **查看结果**: 对比 Z 区间数和总时间
3. **评估效果**: 如果满意,保持当前配置
4. **进一步优化**: 如果还需要更快,可以:
   - 增大误差界限 (err = 64 或 128)
   - 进一步降低递归深度 (level >= 8)

## 💡 总结

### 关键改动

```java
// 一行代码的改动
if (level >= 10 || (zEnd - zStart) <= 1) {  // 从 15 改为 10
```

### 预期效果

- ✅ Z 区间数减少 65-75%
- ✅ 查询次数大幅减少
- ✅ 总时间提升 2-3 倍
- ⚠️ 假阳性率可能略微增加

### 适用场景

- ✅ 所有需要提升性能的场景
- ✅ 可以接受少量假阳性的场景
- ✅ 查询选择性较大的场景 (0.01-0.05)

现在运行测试,看看实际效果吧! 🎉

